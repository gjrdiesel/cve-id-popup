// Thanks to https://stackoverflow.com/a/49092029
function highlight(elem = document.body) {
  Array.from(elem.childNodes).forEach(child => {
    const keywordRegex = /cve-\d{4}-\d{4,7}/i
    if (child.nodeType !== 3) { // not a text node
      highlight(child);
    } else if (keywordRegex.test(child.textContent)) {
      if(child.parentNode.classList.contains("cve-popover")){
        return
      }

      const frag = document.createDocumentFragment();
      let lastIdx = 0;
      child.textContent.replace(keywordRegex, (match, idx) => {
        const popover = document.createElement('span');
        popover.classList.add('cve-popover','popover__content');

        // Todo: Replace with an API call - S3 or anything exist for these?
        popover.innerHTML = `<div><a class="cve-popover" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=${match}" target="_blank">${match}</a>:</div>procfs in FreeBSD and possibly other operating systems does not properly restrict access to per-process mem and ctl files, which allows local users to gain root privileges by forking a child process and executing a privileged process from the child, while the parent retains access to the child's address space.`;

        const part = document.createTextNode(child.textContent.slice(lastIdx, idx));
        const highlighted = document.createElement('span');
        highlighted.textContent = match;
        highlighted.classList.add('cve-popover','popover__wrapper');

        highlighted.appendChild(popover);

        frag.appendChild(part);
        frag.appendChild(highlighted);
        lastIdx = idx + match.length;
      });
      const end = document.createTextNode(child.textContent.slice(lastIdx));
      frag.appendChild(end);
      child.parentNode.replaceChild(frag, child);
    }
  });
}

window.onload = highlight;
setInterval(highlight, 1000);
